#!/usr/bin/env ruby -w

root = File.expand_path(File.join(File.dirname(__FILE__), "../lib"))

begin
  require "simpleconsole"
  require "fssm"
  require "#{root}/judo.rb"
rescue LoadError
  require "rubygems"
  require "simpleconsole"
  require "fssm"
  require "#{root}/judo.rb"
end

module Judo
  module Command
    def watch
      require "fssm"
      watch_root = Dir.getwd
      
      raise "judo.conf was not located in #{watch_root}" unless File.exists? "#{watch_root}/judo.conf"
      puts ">>> Judo is watching for changes. Press Ctrl-C to stop."
      Judo::Project.project_path "#{watch_root}/"
      Judo::Project.update
      
      FSSM.monitor do
        path "#{watch_root}/elements" do
          glob "**/*.js"

          update do |base, relative|
            puts "change detected in #{relative}"
            Judo::Project.update
          end

          create do |base, relative|
            puts "#{relative} created"
            Judo::Project.update
          end
        end
        
        path "#{watch_root}/models" do
          glob "**/*.js"

          update do |base, relative|
            puts "change detected in #{relative}"
            Judo::Project.update
          end

          create do |base, relative|
            puts "#{relative} created"
            Judo::Project.update
          end
        end
        
        path "#{watch_root}/modules" do
          glob "**/*.js"

          update do |base, relative|
            puts "change detected in #{relative}"
            Judo::Project.update
          end

          create do |base, relative|
            puts "#{relative} created"
            Judo::Project.update
          end
        end
        
      end
      
    end

    def create(name, directory)
      raise 'you must specify a project name: judo create -n "ProjectName"' if name.nil?
      directory.nil? ? Judo::Project.create(name, "/") : Judo::Project.create(name, directory)
    end
    
    def compile
      watch_root = Dir.getwd
      
      raise "judo.conf was not located in #{watch_root}" unless File.exists? "#{watch_root}/judo.conf"
      Judo::Project.project_path "#{watch_root}/"
      Judo::Project.update
    end

    def help
      puts <<-DOC
      
Description: 
The judo command line tool will compile your judo application into modules.
To compile your judo application into module files:

Usage: judo [action] [options]
  
Actions:
  compile  Compiles the judo project in the current working directory
  watch    Watches the current working directory for 
           file changes and compiles when files change
  create   Generates judo application architecture and files
  
Options:
  -n, --name       Name of the judo application to create
  -d, --directory  Optional install directory for a new judo project
                   (creates the folder if it does not exist)
  
Example:
  // Generate a new judo application in the js folder
  // (creates folder if it doesn't exist)
  judo create -n "MyApplication" -d "js"
  
  // cd to the judo root folder (ie. js)
  judo watch -or- judo compile
      DOC
    end

    module_function :create, :watch, :compile, :help
  end
end

class Controller < SimpleConsole::Controller
  params :string => {:n => :name,
                     :d => :directory},
         :bool => {:h => :help}
         
  def default
    Judo::Command.help
  end
  
  def help
    Judo::Command.help
  end
  
  def create
    name = params[:name]
    directory = params[:directory] || '/'
    raise 'name is undefined: judo create -n "MyAppName"' if name.nil?
    Judo::Command.create(name, directory)
  end
  
  def compile
    Judo::Command.compile
  end
  
  def watch
    Judo::Command.watch
  end
end

class View < SimpleConsole::View
end

SimpleConsole::Application.run(ARGV, Controller, View)