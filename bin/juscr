#!/usr/bin/env ruby -w

$LOAD_PATH << '../lib'
require 'rubygems'
require 'simpleconsole'
require 'juscr.rb'


class Controller < SimpleConsole::Controller
  params :bool => {:c => :compress,
                   :h => :help,
                   :v => :version},
         :string => {:f => :files,
                     :d => :directory,
                     :n => :name}
  def setup
    @root = Dir.getwd << '/'
    @juscr = Juscr.new
  end


  def default
    setup
    if params[:version]
      version
    else
      show_docs
    end
  end
  
  def compile
    begin
      raise ArgumentError, "You must specify an output filename: -n 'compressed.js" if params[:name].nil?
      
      @filename = params[:name]
      @compress = params[:compress] ? params[:compress] : false
      
      select_config
      
      @compiler = JuscrCompiler.new(@compress)
      @compiler.compile(@files, @filename)
    rescue RuntimeError => e
      puts e.message
      puts e.backtrace.inspect
    end
  end

  def select_config
    files_string = params[:files] ? params[:files] : false
    directory = params[:directory] ? params[:directory] : false
    
    if File.exists? @root + 'juscr.conf'
      config = JuscrConfigParser.new @root + 'juscr.conf'
      @compress = config.compress
      @files = config.files
    end
    
    if directory
      directory = @juscr.clean_dir_path directory
      @files = @juscr.get_directory_contents directory
    end
    
    if files_string
      raise ArgumentError, "files must be a comma dilineated string of filenames: juscr compile -f 'fileone.js, filetwo.js'" if files_string =~ /(\[|\]|\'|\{|\}|\=|\>)/
      @files = files_string.split(/\,\s*/)
    end
  end

  def version
    puts 'juscr ' << @juscr.version << ' (2010-7-3)'
  end
  
  def show_docs
    puts <<DOC
    
Juscr #{@version} by Dayton Nolan
Usage: juscr [action] [options]

Description: 
Compile and compress multiple javascript files into a single file

To compile and javascript files and compress them with JSMin:

  juscr compile -f 'jquery-1.4.1.min, jquery.plugin.js, myjavascript.js' -n 'compiledscripts.js'

Options:
-n, --name        Specify the name of the compiled output file


Mode Options(only specify one):
-f, --files       Comma dilineated string of files to compiled
-d, --directory   Name of directory containing files to compile

-?, -h, --help

Requirements:
simpleconsole     gem install simpleconsole
jsmin             gem install jsmin

DOC
  end
    
end

class View < SimpleConsole::View
  def default
    
  end
end

SimpleConsole::Application.run(ARGV, Controller)